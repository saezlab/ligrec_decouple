---
title: "squdpy_nes_obtain_data"
author: "Daniel Dimitrov"
date: "10/8/2021"
output: html_document
---

## Load Required Libs
```{r setup, include=FALSE}
require(tidyverse)
require(reticulate)
require(Seurat)
require(magrittr)
require(liana)
```

```{python pysetup}
import scanpy as sc
import pandas as pd
import numpy as np
import squidpy as sq
import anndata2ri
```
## Obtain data and enrichment
```{python get_adata_nes}
"""""
Title: Function to return the EM and do NES with Squidpy

params:
    adata - anndata
    coord_type - type of coordinate system
    cluster_key - variable where clustering is stored
    spatial_key - where spatial coordinates are stored - for some reason relevant for neighbourhood analysis
    kwargs - passed to plot
    
    
returns: list with processed adata and Neighbourhood Enrichment Scores (NES)
"""""
def get_adata_nes(adata, cluster_key, spatial_key = "spatial", **kwargs):
    sq.gr.spatial_neighbors(adata, coord_type="generic", spatial_key=spatial_key)
    sq.gr.nhood_enrichment(adata, cluster_key=cluster_key)
    sq.pl.nhood_enrichment(adata, cluster_key=cluster_key, **kwargs)
    
    # nes
    cats = adata.obs[cluster_key].cat.categories
    nes_key = "{}_nhood_enrichment".format(cluster_key)
    nes = pd.DataFrame(adata.uns[nes_key]['zscore'], index=cats, columns=cats)
    
    both = dict(adata = adata, nes = nes)
    return(both)
```



```{python load_sq_data}
# https://squidpy.readthedocs.io/en/stable/auto_tutorials/tutorial_merfish.html#sphx-glr-auto-tutorials-tutorial-merfish-py
adata = sq.datasets.seqfish()
seq_adata_nes = get_adata_nes(adata, cluster_key="celltype_mapped_refined", method="ward")


# https://squidpy.readthedocs.io/en/stable/auto_tutorials/tutorial_seqfish.html#sphx-glr-auto-tutorials-tutorial-seqfish-py
adata = sq.datasets.seqfish()
sq.gr.spatial_neighbors(adata, coord_type="generic")
sq.gr.nhood_enrichment(adata, cluster_key="celltype_mapped_refined")
sq.pl.nhood_enrichment(adata, cluster_key="celltype_mapped_refined", method="ward")

# nes
cats = adata.obs["celltype_mapped_refined"].cat.categories
nes = pd.DataFrame(adata.uns['celltype_mapped_refined_nhood_enrichment']['zscore'],
                   index=cats,
                   columns=cats)
```

## Convert to Seurat
```{r to_seurat, warning = FALSE}
exprs <- t(as.matrix(py$adata$X))
colnames(exprs) <- py$adata$obs_names$to_list()
rownames(exprs) <- py$adata$var_names$to_list()
# Create the Seurat object
seurat_object <- CreateSeuratObject(exprs)
# Set the expression assay
seurat_object <- SetAssayData(seurat_object, "counts", exprs)
# Add observation metadata
seurat_object <- AddMetaData(seurat_object, py$adata$obs)

# remove low quality cells
seurat_object@meta.data %<>% filter(celltype_mapped_refined!="Low quality") %>%
            mutate(seurat_clusters = str_replace(celltype_mapped_refined, "/", " ") %>% as.factor())
seurat_object <- subset(seurat_object, cells=rownames(seurat_object@meta.data))

Idents(seurat_object) <- seurat_object@meta.data$seurat_clusters

# run normalization etc
seurat_object %<>% 
    Seurat::SCTransform(verbose = FALSE) %>%
    Seurat::FindVariableFeatures() %>%
    Seurat::RunPCA(., verbose = FALSE) %>%
    Seurat::RunUMAP(., dims = 1:30, verbose = FALSE) 

saveRDS(seurat_object, "data/input/spatial/fishes/seqFISH_seurat.RDS")

# get NES
nes <- py$nes
saveRDS(nes, "data/input/spatial/fishes/seqFISH_nes.RDS")
```


## Run LIANA (to be moved outside of rmd due to issue with python versions)
```{r run_liana}
require(liana)
require(tidyverse)
require(magrittr)

op_resource <- readRDS("data/input/murine_omnipath.RDS")
liana_res <- liana_wrap(seurat_object,
                        cellchat.params=list(organism="mouse"),
                        resource = "custom",
                        external_resource = op_resource,
                        assay="SCT",
                        squidpy.param = list(cluster_key = "seurat_clusters"))


# squidpy sets gene names to upper (in the processing), revert this to title (i.e. murine)
liana_res$squidpy %<>%
    mutate_at(.vars = c("ligand", "receptor"), str_to_title)
liana_res %<>% liana_aggregate

```



## Spatial-LR eval
### Corr to NES
```{r }
n_rank = 5000
liana_res_ag <- liana_res %>% liana_aggregate(cap=n_rank)
# LIANA
liana_prop <- liana_res_ag %>%
    dplyr::select(source, target, ends_with("rank"), -c(mean_rank, median_rank)) %>%
    mutate(aggregate_rank = min_rank(aggregate_rank)) %>%
    pivot_longer(-c(source,target),
                 names_to = "method_name",
                 values_to = "rank") %>%
    filter(rank < n_rank) %>%
    group_by(method_name) %>%
    mutate(tot_n = n()) %>%
    group_by(source, target, method_name) %>%
    mutate(n = n()) %>%
    group_by(source, target, method_name) %>%
    mutate(prop = n/tot_n) %>%
    dplyr::select(source, target, method_name, prop) %>%
    distinct() %>%
    group_by(method_name) %>%
    mutate(check_prop = sum(prop)) %>%
    mutate(across(.cols = c(source, target), ~gsub("\\/", " ", .x)))

net_form <- nes %>% 
    rownames_to_column("celltype1") %>% 
    pivot_longer(-celltype1,
                 names_to = "celltype2",
                 values_to = "estimate") %>%
    mutate(across(.cols = c(celltype1, celltype2), ~gsub("\\/", " ", .x)))

liana_corr <- liana_prop %>%
    left_join(net_form, by = c("source"="celltype1",
                               "target"="celltype2")) %>%
    filter(source!=target) %>%
    mutate(across(.cols = c(source, target), ~stringr::str_replace_all(.x, "[/]", " "))) %>%
    mutate(across(.cols = c(source, target), ~stringr::str_replace_all(.x, "[/]", " "))) %>%
    group_by(method_name) %>%
    group_nest() %>%
    mutate(correlation = data %>%
               map(function(d) d %>%
                       summarise(correlation = cor(prop,
                                                   estimate,
                                                   method = "pearson")))) %>%
    unnest(correlation)
liana_corr
```

### Roc from NES
```{r}
liana_res_ag <- liana_res %>% liana_aggregate()

nes_response <- nes %>% 
    rownames_to_column("celltype1") %>% 
    pivot_longer(-celltype1,
                 names_to = "celltype2",
                 values_to = "estimate") %>%
    dplyr::mutate(response = case_when(estimate >= 0 ~ 1,
                                       estimate < 0 ~ 0)) %>%
    dplyr::mutate(response = if_else(celltype1==celltype2, 0, response))

hist(nes_response$estimate)

liana_response <- liana_res_ag %>%
    left_join(nes_response, by = c("source"="celltype1",
                                    "target"="celltype2")) %>%
    filter(source!=target) %>% # REMOVE autocrine
    unite(source, ligand, target, receptor, col = "interaction") %>%
    dplyr::select(interaction, ends_with("rank"), response) %>%
    pivot_longer(cols = -c(interaction, response),
                 names_to = "method_name",
                 values_to = "predictor") %>%
    mutate(response = factor(response, levels = c(1, 0))) %>%
    mutate(predictor = predictor*-1)
    
# Roc
lr_space_res <- liana_response %>%
    group_by(method_name) %>%
    filter(!(method_name %in% c("mean_rank", "median_rank"))) %>%
    group_nest(.key = "corr_rank") %>%
    mutate(roc = map(corr_rank, function(df) calc_curve(df, curve="ROC"))) %>%
    mutate(prc = map(corr_rank, function(df) calc_curve(df, curve = "PR",
                                                        downsampling = TRUE,
                                                        times = 100)))
# lr_space_auroc <-
lr_space_res %>%
    dplyr::select(method_name, roc) %>%
    unnest(roc) %>%
    dplyr::select(method_name, auc) %>%
    distinct()


lr_space_res %>%
    dplyr::select(method_name, prc) %>%
    unnest(prc) %>%
    dplyr::select(method_name, auc) %>%
    distinct()

```
