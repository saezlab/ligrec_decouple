---
title: "squdpy_nes"
author: "Daniel Dimitrov"
date: "10/8/2021"
output: html_document
---

## Load Required Libs
```{r setup, include=FALSE}
require(tidyverse)
require(reticulate)
require(Seurat)
require(magrittr)
```

```{python pysetup}
import scanpy as sc
import pandas as pd
import numpy as np
import squidpy as sq
import anndata2ri
```

## Obtain data and enrichment
```{python load_sq_data}
adata = sq.datasets.seqfish()
sq.gr.spatial_neighbors(adata, coord_type="generic")
sq.gr.nhood_enrichment(adata, cluster_key="celltype_mapped_refined")
sq.pl.nhood_enrichment(adata, cluster_key="celltype_mapped_refined", method="ward")

# nes
cats = adata.obs["celltype_mapped_refined"].cat.categories
nes = pd.DataFrame(adata.uns['celltype_mapped_refined_nhood_enrichment']['zscore'],
                   index=cats,
                   columns=cats)
```

## Convert to Seurat
```{r to_seurat}
exprs <- t(py$adata$X)
colnames(exprs) <- py$adata$obs_names$to_list()
rownames(exprs) <- py$adata$var_names$to_list()
# Create the Seurat object
seurat_object <- CreateSeuratObject(exprs)
# Set the expression assay
seurat_object <- SetAssayData(seurat_object, "counts", exprs)
# Add observation metadata
seurat_object <- AddMetaData(seurat_object, py$adata$obs)
Idents(seurat_object) <- seurat_object@meta.data$celltype_mapped_refined


# remove low quality cells
seurat_object@meta.data %<>% filter(celltype_mapped_refined!="Low quality")
seurat_object <- subset(seurat_object, cells=rownames(seurat_object@meta.data))

# run normalization etc
seurat_object %<>% Seurat::SCTransform(verbose = FALSE) %>%
    Seurat::FindVariableFeatures() %>%
    Seurat::RunPCA(., verbose = FALSE) %>%
    Seurat::RunUMAP(., dims = 1:30, verbose = FALSE) 


# get NES
nes <- py$nes
```


## Run LIANA
```{r run_lian}
require(liana)
require(tidyverse)
require(magrittr)
require("biomaRt")

#' Basic function to convert human to mouse genesymbols (temporary solution)
#' @param op_resource omnipath_resource as obtained via `liana::select_resource`
#'
#' @details adapted from https://www.r-bloggers.com/2016/10/converting-mouse-to-human-gene-names-with-biomart-package/
convert_to_murine <- function(op_resource){

    # query biomaRt databases
    human <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")
    mouse <- useMart("ensembl", dataset = "mmusculus_gene_ensembl")

    # obtain tibble with human and murine genesymbol
    symbols_tibble <- getLDS(attributes = c("hgnc_symbol"),
                             filters = "hgnc_symbol",
                             values = union(op_resource$source_genesymbol,
                                            op_resource$target_genesymbol),
                             mart = human,
                             martL = mouse,
                             attributesL = c("mgi_symbol")) %>%
        dplyr::rename(human_symbol = HGNC.symbol,
                      murine_symbol = MGI.symbol) %>%
        as_tibble()

    # intentionally we introduce duplicates, if needed
    # these should be resolved when LIANA is called
    # as inappropriately matched genes will not be assigned any values
    op_resource %>%
        left_join(symbols_tibble, by=c("target_genesymbol"="human_symbol")) %>%
        mutate(target_genesymbol = murine_symbol, .keep = "unused") %>%
        left_join(symbols_tibble, by=c("source_genesymbol"="human_symbol")) %>%
        mutate(source_genesymbol = murine_symbol, .keep = "unused") %>%
        filter(!is.na(target_genesymbol) | !is.na(source_genesymbol)) %>%
        filter(!is.na(target_genesymbol)) %>%
        filter(!is.na(source_genesymbol))
}


op_resource <- select_resource("OmniPath")[[1]] %>%
    convert_to_murine()

liana_res <- liana_wrap(seurat_object,
                        cellchat.params=list(organism="mouse"),
                        resource = "custom",
                        external_resource = op_resource,
                        assay="SCT",
                        squidpy.param = list(cluster_key = "celltype_mapped_refined"),
                        method = c("cellchat", "call_connectome", "call_italk"))


# squidpy sets gene names to upper (in the processing), revert this to title (i.e. murine)
liana_res$squidpy %<>%
    mutate_at(.vars = c("ligand", "receptor"), str_to_title)


liana_res %<>% liana_aggregate

```

```{r}
input_data <- Seurat::GetAssayData(seurat_object,
                                   assay = "SCT",
                                   slot = "data") %>%
    as.matrix()
labels <- Seurat::Idents(seurat_object)
```

## Spatial-LR eval
### Corr to NES
```{r }
n_rank = 50
liana_res_ag <- liana_res %>% liana_aggregate(cap=n_rank)
# LIANA
liana_prop <- liana_res_ag %>%
    dplyr::select(source, target, ends_with("rank"), -c(mean_rank, median_rank)) %>%
    mutate(aggregate_rank = min_rank(aggregate_rank)) %>%
    pivot_longer(-c(source,target),
                 names_to = "method_name",
                 values_to = "rank") %>%
    filter(rank < n_rank) %>%
    group_by(method_name) %>%
    mutate(tot_n = n()) %>%
    group_by(source, target, method_name) %>%
    mutate(n = n()) %>%
    group_by(source, target, method_name) %>%
    mutate(prop = n/tot_n) %>%
    dplyr::select(source, target, method_name, prop) %>%
    distinct() %>%
    group_by(method_name) %>%
    mutate(check_prop = sum(prop))

net_form <- nes %>% 
    rownames_to_column("celltype1") %>% 
    pivot_longer(-celltype1,
                 names_to = "celltype2",
                 values_to = "estimate")

liana_corr <- liana_prop %>%
    left_join(net_form, by = c("source"="celltype1",
                               "target"="celltype2")) %>%
    filter(source!=target) %>%
    group_by(method_name) %>%
    group_nest() %>%
    mutate(correlation = data %>%
               map(function(d) d %>%
                       mutate(estimate = replace_na(estimate, 0)) %>%
                       summarise(correlation = cor(prop,
                                                   estimate,
                                                   method = "pearson")))) %>%
    unnest(correlation)
liana_corr
```

### Roc from NES
